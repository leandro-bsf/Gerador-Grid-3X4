<script>
const imageUpload = document.getElementById('imageUpload');
const generatePdf = document.getElementById('generatePdf');
const pdfPage = document.getElementById('pdf-page');
const statusMessage = document.getElementById('status-message');
const loadingMessage = document.getElementById('loading-message');
const generateButton = document.getElementById('generatePdf');

const { jsPDF } = window.jspdf;

let selectedFiles = [];
let loadedImageUrls = [];

imageUpload.addEventListener('change', (event) => {
    pdfPage.innerHTML = '';
    statusMessage.style.display = 'none';
    loadingMessage.style.display = 'none';

    loadedImageUrls.forEach(url => URL.revokeObjectURL(url));
    loadedImageUrls = [];

    selectedFiles = Array.from(event.target.files);

    // NOVA REGRA — mínimo livre, máximo 42
    if (selectedFiles.length > 42) {
        statusMessage.textContent = `Você selecionou ${selectedFiles.length} fotos. O máximo permitido é 42.`;
        statusMessage.style.display = 'block';
        generateButton.disabled = true;
        return;
    }

    if (selectedFiles.length === 0) {
        statusMessage.textContent = `Selecione pelo menos 1 foto.`;
        statusMessage.style.display = 'block';
        generateButton.disabled = true;
        return;
    }

    generateButton.disabled = true;
    generateButton.textContent = 'Carregando...';
    loadingMessage.style.display = 'block';

    let imagePromises = [];

    for (const file of selectedFiles) {
        const img = document.createElement('img');
        img.classList.add('photo-item');

        const url = URL.createObjectURL(file);
        loadedImageUrls.push(url);

        const promise = new Promise((resolve, reject) => {
            img.onload = () => resolve();
            img.onerror = () => reject();
        });

        imagePromises.push(promise);

        img.src = url;
        pdfPage.appendChild(img);
    }

    Promise.all(imagePromises)
        .then(() => {
            generateButton.disabled = false;
            generateButton.textContent = 'Gerar PDF';
            loadingMessage.style.display = 'none';
        })
        .catch((err) => {
            console.error('Erro ao carregar a imagem:', err);
            statusMessage.textContent = 'Erro ao carregar uma das imagens. Tente novamente.';
            statusMessage.style.display = 'block';
            loadingMessage.style.display = 'none';
            generateButton.textContent = 'Gerar PDF';
        });
});

generatePdf.addEventListener('click', () => {
    if (selectedFiles.length === 0) {
        alert('Selecione pelo menos 1 foto.');
        return;
    }

    generateButton.disabled = true;
    generateButton.textContent = 'Gerando PDF...';
    loadingMessage.style.display = 'block';

    const element = document.getElementById('pdf-page');

    const options = {
        scale: 2,
        useCORS: true,
        logging: true
    };

    html2canvas(element, options).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');

        pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
        pdf.save('folha_fotos_3x4.pdf');

        generateButton.disabled = false;
        generateButton.textContent = 'Gerar PDF';
        loadingMessage.style.display = 'none';

        loadedImageUrls.forEach(url => URL.revokeObjectURL(url));
        loadedImageUrls = [];

    }).catch(err => {
        console.error('Erro ao gerar PDF:', err);
        alert('Erro ao gerar o PDF. Veja o console.');
        generateButton.disabled = false;
        generateButton.textContent = 'Gerar PDF';
        loadingMessage.style.display = 'none';
    });
});
</script>
